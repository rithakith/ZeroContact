using UnityEngine;
using UnityEngine.UI;
using TMPro;
using UnityEngine.SceneManagement;
using System.Collections;
using UnityEngine.InputSystem;

public class ControlsTutorialManager : MonoBehaviour
{
    [System.Serializable]
    public class TutorialScreen
    {
        public string title;
        [TextArea(5, 10)]
        public string content;
        public bool hasDemo;
        public DemoType demoType;
        public string buttonText = "NEXT";
    }
    
    public enum DemoType
    {
        None,
        Jump,
        MoveLeftRight,
        ShieldDeflect,
        ShieldAbsorb,
        ShieldBypass
    }
    
    [Header("UI References")]
    public GameObject screenContainer;
    public TextMeshProUGUI titleText;
    public TextMeshProUGUI contentText;
    public Button nextButton;
    public TextMeshProUGUI buttonText;
    public GameObject demoArea;
    public Image backgroundOverlay;
    
    [Header("Demo Layout - Split Screen")]
    public GameObject leftPanel;  // For player demo
    public GameObject rightPanel; // For instructions
    public TextMeshProUGUI demoInstructionText;
    
    [Header("Demo Elements")]
    public GameObject playerPrefab; // Use actual Player prefab from game
    public Transform demoSpawnPoint;
    public GameObject enemyDemoPrefab;
    public Transform enemySpawnPoint;
    public Camera demoCamera; // Separate camera for demo area
    
    [Header("Visual Styling")]
    public Color normalButtonColor = new Color(0.2f, 0.2f, 0.2f, 0.8f);
    public Color hoverButtonColor = new Color(0.3f, 0.3f, 0.3f, 0.9f);
    public Color pressedButtonColor = new Color(0.1f, 0.1f, 0.1f, 0.8f);
    public Color textColor = Color.white;
    public float fadeSpeed = 2f;
    public float screenTransitionTime = 0.5f;
    
    [Header("Tutorial Screens")]
    public TutorialScreen[] tutorialScreens = new TutorialScreen[]
    {
        new TutorialScreen
        {
            title = "YOUR CHILDHOOD FRIEND HAS BEEN TAKEN",
            content = "Alien forces have abducted her.\nEvery moment we waste, she slips further away.\n\nYou must master the Zero Contact Shield\nto survive the alien dungeons ahead.\n\nFollow these instructions carefully.\nHer life depends on it.",
            hasDemo = false,
            demoType = DemoType.None,
            buttonText = "NEXT - Time is running out"
        },
        new TutorialScreen
        {
            title = "ZERO CONTACT SHIELD SYSTEM",
            content = "This adaptive shield is your only defense\nagainst the alien threat.\n\nMaster it quickly.\nYour friend needs you.",
            hasDemo = false,
            demoType = DemoType.None,
            buttonText = "BEGIN TRAINING"
        },
        new TutorialScreen
        {
            title = "BASIC MOVEMENT - JUMPING",
            content = "Press Space to JUMP\n\nEssential for dodging ground attacks\nand navigating vertical obstacles.",
            hasDemo = true,
            demoType = DemoType.Jump,
            buttonText = "NEXT when ready"
        },
        new TutorialScreen
        {
            title = "BASIC MOVEMENT - LEFT/RIGHT",
            content = "Press LEFT or RIGHT to MOVE\n\nQuick positioning saves lives.\nStay mobile to survive.",
            hasDemo = true,
            demoType = DemoType.MoveLeftRight,
            buttonText = "NEXT when ready"
        },
        new TutorialScreen
        {
            title = "ACTIVATING YOUR SHIELD",
            content = "Your shield adapts to counter specific threats.\nWrong mode = certain death.\n\nLearn each mode. Fast.",
            hasDemo = false,
            demoType = DemoType.None,
            buttonText = "LEARN SHIELD MODES"
        },
        new TutorialScreen
        {
            title = "SHIELD MODE: DEFLECT",
            content = "Press SPACE to DEFLECT\n\nReflects physical projectiles back at enemies.\nPerfect timing multiplies damage.",
            hasDemo = true,
            demoType = DemoType.ShieldDeflect,
            buttonText = "NEXT when mastered"
        },
        new TutorialScreen
        {
            title = "SHIELD MODE: ABSORB",
            content = "Hold SPACE to ABSORB\n\nNeutralizes elemental attacks (fire, electricity).\nConverts absorbed energy for shield power.",
            hasDemo = true,
            demoType = DemoType.ShieldAbsorb,
            buttonText = "NEXT when mastered"
        },
        new TutorialScreen
        {
            title = "SHIELD MODE: BYPASS",
            content = "Double-tap SPACE to BYPASS\n\nPhase through unblockable attacks.\nDrains shield energy - use wisely.",
            hasDemo = true,
            demoType = DemoType.ShieldBypass,
            buttonText = "NEXT when mastered"
        },
        new TutorialScreen
        {
            title = "ENEMY ATTACK PATTERNS",
            content = "Every alien telegraphs their attack.\nWatch. Learn. React.\n\nPhysical = Heavy, slow swings\nFire = Glowing, area damage\nElectric = Sparking, chain strikes",
            hasDemo = false,
            demoType = DemoType.None,
            buttonText = "CONTINUE"
        },
        new TutorialScreen
        {
            title = "ELEMENTAL DUNGEONS AHEAD",
            content = "Each dungeon amplifies specific attack types:\n\nPHYSICAL ZONE: Brutal melee combat\nFIRE ZONE: Constant burning threats\nELECTRIC ZONE: Lightning-fast strikes\n\nAdapt or perish.",
            hasDemo = false,
            demoType = DemoType.None,
            buttonText = "ALMOST READY"
        },
        new TutorialScreen
        {
            title = "TIME TO MOVE",
            content = "Your friend is counting on you.\nYou've learned the basics.\n\nRemember:\n- Stay mobile\n- Match shield to attack type\n- Perfect timing saves energy\n\nGo. Save her.",
            hasDemo = false,
            demoType = DemoType.None,
            buttonText = "BEGIN THE RESCUE"
        }
    };
    
    private int currentScreenIndex = 0;
    private GameObject currentDemoPlayer;
    private GameObject currentDemoEnemy;
    private Coroutine demoCoroutine;
    private PlayerInput playerInput;
    private PlayerController playerController;
    private bool isDemoActive = false;
    
    void Start()
    {
        SetupUI();
        ShowScreen(0);
        
        if (playerInput == null)
        {
            playerInput = GetComponent<PlayerInput>();
            if (playerInput == null)
            {
                playerInput = gameObject.AddComponent<PlayerInput>();
            }
        }
    }
    
    void SetupUI()
    {
        if (nextButton != null)
        {
            nextButton.onClick.AddListener(NextScreen);
            
            ColorBlock colors = nextButton.colors;
            colors.normalColor = normalButtonColor;
            colors.highlightedColor = hoverButtonColor;
            colors.pressedColor = pressedButtonColor;
            colors.colorMultiplier = 1f;
            colors.fadeDuration = 0.1f;
            nextButton.colors = colors;
        }
        
        if (titleText != null)
        {
            titleText.color = textColor;
        }
        
        if (contentText != null)
        {
            contentText.color = textColor;
        }
        
        if (buttonText != null)
        {
            buttonText.color = textColor;
        }
    }
    
    void ShowScreen(int index)
    {
        if (index < 0 || index >= tutorialScreens.Length) return;
        
        currentScreenIndex = index;
        TutorialScreen screen = tutorialScreens[index];
        
        StartCoroutine(TransitionToScreen(screen));
    }
    
    IEnumerator TransitionToScreen(TutorialScreen screen)
    {
        float elapsedTime = 0f;
        
        while (elapsedTime < screenTransitionTime / 2)
        {
            float alpha = Mathf.Lerp(1f, 0f, elapsedTime / (screenTransitionTime / 2));
            SetUIAlpha(alpha);
            elapsedTime += Time.deltaTime;
            yield return null;
        }
        
        UpdateScreenContent(screen);
        
        elapsedTime = 0f;
        while (elapsedTime < screenTransitionTime / 2)
        {
            float alpha = Mathf.Lerp(0f, 1f, elapsedTime / (screenTransitionTime / 2));
            SetUIAlpha(alpha);
            elapsedTime += Time.deltaTime;
            yield return null;
        }
        
        SetUIAlpha(1f);
        
        if (screen.hasDemo)
        {
            StartDemo(screen.demoType);
        }
    }
    
    void UpdateScreenContent(TutorialScreen screen)
    {
        if (titleText != null)
            titleText.text = screen.title;
            
        if (buttonText != null)
            buttonText.text = screen.buttonText;
            
        // Handle different layouts for demo vs non-demo screens
        if (screen.hasDemo)
        {
            // Split screen layout
            if (leftPanel != null) leftPanel.SetActive(true);
            if (rightPanel != null) rightPanel.SetActive(true);
            if (demoArea != null) demoArea.SetActive(true);
            
            // Hide center content, show demo instruction
            if (contentText != null) contentText.gameObject.SetActive(false);
            if (demoInstructionText != null)
            {
                demoInstructionText.gameObject.SetActive(true);
                demoInstructionText.text = screen.content;
            }
            
            // Enable demo camera
            if (demoCamera != null) demoCamera.gameObject.SetActive(true);
        }
        else
        {
            // Full screen layout for non-demo screens
            if (leftPanel != null) leftPanel.SetActive(false);
            if (rightPanel != null) rightPanel.SetActive(false);
            if (demoArea != null) demoArea.SetActive(false);
            
            // Show center content
            if (contentText != null)
            {
                contentText.gameObject.SetActive(true);
                contentText.text = screen.content;
            }
            if (demoInstructionText != null) demoInstructionText.gameObject.SetActive(false);
            
            // Disable demo camera
            if (demoCamera != null) demoCamera.gameObject.SetActive(false);
        }
    }
    
    void SetUIAlpha(float alpha)
    {
        if (titleText != null)
        {
            Color c = titleText.color;
            c.a = alpha;
            titleText.color = c;
        }
        
        if (contentText != null)
        {
            Color c = contentText.color;
            c.a = alpha;
            contentText.color = c;
        }
        
        if (buttonText != null)
        {
            Color c = buttonText.color;
            c.a = alpha;
            buttonText.color = c;
        }
    }
    
    void StartDemo(DemoType demoType)
    {
        if (demoCoroutine != null)
        {
            StopCoroutine(demoCoroutine);
        }
        
        CleanupDemo();
        isDemoActive = true;
        
        switch (demoType)
        {
            case DemoType.Jump:
                demoCoroutine = StartCoroutine(DemoJump());
                break;
            case DemoType.MoveLeftRight:
                demoCoroutine = StartCoroutine(DemoMove());
                break;
            case DemoType.ShieldDeflect:
                demoCoroutine = StartCoroutine(DemoShieldDeflect());
                break;
            case DemoType.ShieldAbsorb:
                demoCoroutine = StartCoroutine(DemoShieldAbsorb());
                break;
            case DemoType.ShieldBypass:
                demoCoroutine = StartCoroutine(DemoShieldBypass());
                break;
        }
    }
    
    void UpdateDemoInstruction(string instruction)
    {
        if (demoInstructionText != null)
        {
            demoInstructionText.text = instruction;
        }
    }
    
    IEnumerator DemoJump()
    {
        if (playerPrefab != null && demoSpawnPoint != null)
        {
            currentDemoPlayer = Instantiate(playerPrefab, demoSpawnPoint.position, Quaternion.identity);
            currentDemoPlayer.transform.localScale = Vector3.one; // Keep original scale
            
            // Add PlayerInputSimulator
            PlayerInputSimulator simulator = currentDemoPlayer.AddComponent<PlayerInputSimulator>();
            
            // Focus demo camera on player
            if (demoCamera != null)
            {
                demoCamera.transform.position = new Vector3(demoSpawnPoint.position.x, demoSpawnPoint.position.y, -10);
            }
            
            while (currentDemoPlayer != null && isDemoActive)
            {
                yield return simulator.DemoJumpSequence(3);
                yield return new WaitForSeconds(1f);
            }
        }
    }
    
    IEnumerator DemoMove()
    {
        if (playerPrefab != null && demoSpawnPoint != null)
        {
            currentDemoPlayer = Instantiate(playerPrefab, demoSpawnPoint.position, Quaternion.identity);
            currentDemoPlayer.transform.localScale = Vector3.one;
            
            // Add PlayerInputSimulator
            PlayerInputSimulator simulator = currentDemoPlayer.AddComponent<PlayerInputSimulator>();
            
            // Focus demo camera on player
            if (demoCamera != null)
            {
                demoCamera.transform.position = new Vector3(demoSpawnPoint.position.x, demoSpawnPoint.position.y, -10);
            }
            
            while (currentDemoPlayer != null && isDemoActive)
            {
                yield return simulator.DemoMoveSequence();
                yield return new WaitForSeconds(1f);
            }
        }
    }
    
    IEnumerator DemoShieldDeflect()
    {
        if (playerPrefab != null && demoSpawnPoint != null)
        {
            currentDemoPlayer = Instantiate(playerPrefab, demoSpawnPoint.position, Quaternion.identity);
            currentDemoPlayer.transform.localScale = Vector3.one;
            
            // Add PlayerInputSimulator
            PlayerInputSimulator simulator = currentDemoPlayer.AddComponent<PlayerInputSimulator>();
            
            // Focus demo camera on player
            if (demoCamera != null)
            {
                demoCamera.transform.position = new Vector3(demoSpawnPoint.position.x, demoSpawnPoint.position.y, -10);
            }
            
            if (enemyDemoPrefab != null && enemySpawnPoint != null)
            {
                currentDemoEnemy = Instantiate(enemyDemoPrefab, enemySpawnPoint.position, Quaternion.identity);
            }
            
            while (currentDemoPlayer != null && isDemoActive)
            {
                yield return simulator.DemoShieldDeflectSequence();
                yield return new WaitForSeconds(2f);
            }
        }
    }
    
    IEnumerator DemoShieldAbsorb()
    {
        if (playerPrefab != null && demoSpawnPoint != null)
        {
            currentDemoPlayer = Instantiate(playerPrefab, demoSpawnPoint.position, Quaternion.identity);
            currentDemoPlayer.transform.localScale = Vector3.one;
            
            // Add PlayerInputSimulator
            PlayerInputSimulator simulator = currentDemoPlayer.AddComponent<PlayerInputSimulator>();
            
            // Focus demo camera on player
            if (demoCamera != null)
            {
                demoCamera.transform.position = new Vector3(demoSpawnPoint.position.x, demoSpawnPoint.position.y, -10);
            }
            
            if (enemyDemoPrefab != null && enemySpawnPoint != null)
            {
                currentDemoEnemy = Instantiate(enemyDemoPrefab, enemySpawnPoint.position, Quaternion.identity);
            }
            
            while (currentDemoPlayer != null && isDemoActive)
            {
                yield return simulator.DemoShieldAbsorbSequence();
                yield return new WaitForSeconds(1f);
            }
        }
    }
    
    IEnumerator DemoShieldBypass()
    {
        if (playerPrefab != null && demoSpawnPoint != null)
        {
            currentDemoPlayer = Instantiate(playerPrefab, demoSpawnPoint.position, Quaternion.identity);
            currentDemoPlayer.transform.localScale = Vector3.one;
            
            // Add PlayerInputSimulator
            PlayerInputSimulator simulator = currentDemoPlayer.AddComponent<PlayerInputSimulator>();
            
            // Focus demo camera on player
            if (demoCamera != null)
            {
                demoCamera.transform.position = new Vector3(demoSpawnPoint.position.x, demoSpawnPoint.position.y, -10);
            }
            
            if (enemyDemoPrefab != null && enemySpawnPoint != null)
            {
                currentDemoEnemy = Instantiate(enemyDemoPrefab, enemySpawnPoint.position, Quaternion.identity);
            }
            
            while (currentDemoPlayer != null && isDemoActive)
            {
                yield return simulator.DemoShieldBypassSequence();
                yield return new WaitForSeconds(2f);
            }
        }
    }
    
    void CleanupDemo()
    {
        isDemoActive = false;
        
        if (currentDemoPlayer != null)
        {
            Destroy(currentDemoPlayer);
        }
        
        if (currentDemoEnemy != null)
        {
            Destroy(currentDemoEnemy);
        }
        
        playerController = null;
    }
    
    public void NextScreen()
    {
        if (currentScreenIndex == tutorialScreens.Length - 1)
        {
            SceneManager.LoadScene("MainMenu");
        }
        else
        {
            ShowScreen(currentScreenIndex + 1);
        }
    }
    
    void OnDestroy()
    {
        CleanupDemo();
    }
    
    void Update()
    {
        if (Input.GetKeyDown(KeyCode.Return) || Input.GetKeyDown(KeyCode.Space))
        {
            NextScreen();
        }
        
        if (Input.GetKeyDown(KeyCode.Escape))
        {
            SceneManager.LoadScene("MainMenu");
        }
    }
}